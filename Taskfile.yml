version: '3'

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
vars:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  BUF_VERSION: '1.53.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  OGEN_VERSION: 'v1.12.0'
  YQ_VERSION: 'v4.45.2'
  GRPCURL_VERSION: 'v1.9.3'

  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  BUF: '{{.BIN_DIR}}/buf'
  OGEN: '{{.BIN_DIR}}/ogen'
  YQ: '{{.BIN_DIR}}/yq'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  GRPCURL: '{{.BIN_DIR}}/grpcurl'

  NODE_MODULES_DIR: '{{.ROOT_DIR}}/node_modules/.bin'
  REDOCLY: '{{.NODE_MODULES_DIR}}/redocly'

  OPEN_API_ORDER_V1_BASE: '{{.ROOT_DIR}}/shared/api/order/v1/order.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: '{{.ROOT_DIR}}/shared/api/bundles/order.openapi.v1.bundle.yaml'

  OPEN_API_FILES: '{{.ROOT_DIR}}/shared/api/bundles'

  MODULES: assembly inventory order payment platform iam notification

tasks:
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    summary: |
      –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ gofumpt –∏ gci –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏.
      
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        - gofumpt: –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ Go
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ Go
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci, –∏—Å–∫–ª—é—á–∞—è mocks"
    summary: |
      –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Å–µ Go-—Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º gofumpt –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
      –∏ gci –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö mocks.
      
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
        - gofumpt: –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        
        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
          fi
        done

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ golangci-lint –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ go install.
      
      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç –ª–∏–Ω—Ç–µ—Ä golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
      –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º.
      –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ gosec (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ golangci-lint).
      
      –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
        - install-golangci-lint: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–∏–Ω—Ç–µ—Ä
        - format: —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–¥ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    deps: [ install-golangci-lint ]
    vars:
      MODULES: '{{.MODULES}}'
      GOLANGCI_LINT: '{{.GOLANGCI_LINT}}'
    cmds:
      - |
        set -e
        ERR=0
        echo "üîç –õ–∏–Ω—Ç–∏–º –≤—Å–µ –º–æ–¥—É–ª–∏ ..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîç –õ–∏–Ω—Ç–∏–º $mod module"
            cd "$mod" && {{.GOLANGCI_LINT}} run ./... --config=../.golangci.yml --fix || ERR=1
            cd ..
          fi
        done
        exit $ERR

  test:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç unit —Ç–µ—Å—Ç—ã (go test) –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
      –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–¥ –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö: inventory, order, payment.
    cmds:
      - |
        set -e
        ERR=0
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–æ–¥—É–ª–∏ ..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º $mod module"
            cd "$mod" && go test -v ./... || ERR=1
            cd ..
          fi
        done
        exit $ERR

  test-integration:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ç–µ–≥–æ–º integration –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç testcontainers –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    cmds:
      - |
        set -e
        ERR=0
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã ..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ] && [ -d "$mod/tests/integration" ]; then
            echo "üß™ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è $mod module"
            cd "$mod" && go test -v -tags=integration ./tests/integration/... || ERR=1
            cd ..
          else
            echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º $mod (–Ω–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)"
          fi
        done
        exit $ERR

  install-buf:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Buf –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.BUF}} ] || {
          mkdir -p {{.BIN_DIR}} tmp-buf
          curl -sSL \
            "https://github.com/bufbuild/buf/releases/download/v{{.BUF_VERSION}}/buf-$(uname -s)-$(uname -m).tar.gz" \
            | tar -xz -C tmp-buf
          mv tmp-buf/buf/bin/buf {{.BUF}}
          rm -rf tmp-buf
          chmod +x {{.BUF}}
        }

  proto:install-plugins:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc –ø–ª–∞–≥–∏–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'üì¶ Installing protoc-gen-go...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        }
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'üì¶ Installing protoc-gen-go-grpc...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        }

  proto:gen:
    deps: [ install-buf, proto:install-plugins, proto:lint ]
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto
    dir: shared/proto
    cmds:
      - '{{.BUF}} generate'
      - task: proto:build:inventory
      - task: proto:build:auth
      - task: proto:build:combined

  proto:build:inventory:
    desc: –°–±–æ—Ä–∫–∞ proto –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –¥–ª—è Inventory —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è Envoy gRPC-JSON transcoder)
    deps: [ install-buf, proto:install-plugins ]
    dir: shared/proto
    cmds:
      - 'mkdir -p ../pkg/proto/inventory/v1'
      - '{{.BUF}} build --path inventory --as-file-descriptor-set --output "../pkg/proto/inventory/v1/inventory_descriptor.pb"'

  proto:build:auth:
    desc: –°–±–æ—Ä–∫–∞ proto –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –¥–ª—è Auth —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è Envoy gRPC-JSON transcoder)
    deps: [ install-buf, proto:install-plugins ]
    dir: shared/proto
    cmds:
      - 'mkdir -p ../pkg/proto/auth/v1'
      - '{{.BUF}} build --path auth --as-file-descriptor-set --output "../pkg/proto/auth/v1/auth_descriptor.pb"'

  proto:build:combined:
    desc: –°–±–æ—Ä–∫–∞ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ proto –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –¥–ª—è Envoy (Auth + Inventory)
    deps: [ install-buf, proto:install-plugins ]
    dir: shared/proto
    cmds:
      - 'mkdir -p ../pkg/proto'
      - '{{.BUF}} build --path auth --path inventory --as-file-descriptor-set --output "../pkg/proto/combined_descriptor.pb"'

  proto:lint:
    deps: [ install-buf, proto:install-plugins ]
    desc: –ü—Ä–æ–≤–µ—Ä–∫–∞ .proto-—Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—é
    dir: shared/proto
    cmds:
      - '{{.BUF}} lint'

  redocly-cli:install:
    desc: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ Redocly CLI
    cmds:
      - |
        [ -f {{.REDOCLY}} ] || {
          npm ci
        }

  redocly-cli:order-v1-bundle:
    desc: –°–æ–±—Ä–∞—Ç—å OpenAPI –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π redocly
    deps: [ redocly-cli:install ]
    cmds:
      - '{{.REDOCLY}} bundle {{.OPEN_API_ORDER_V1_BASE}} -o {{.OPEN_API_ORDER_V1_BUNDLE}}'

  redocly-cli:bundle:
    desc: –°–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ö–µ–º—ã OpenAPI –≤ –æ–±—â–∏–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π redocly
    deps: [ redocly-cli:install ]
    cmds:
      - task: redocly-cli:order-v1-bundle

  ogen:install:
    desc: "–°–∫–∞—á–∏–≤–∞–µ—Ç ogen –≤ –ø–∞–ø–∫—É bin"
    cmds:
      - |
        [ -f {{.OGEN}} ] || {
          mkdir -p {{.BIN_DIR}}
          GOBIN={{.BIN_DIR}} go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
        }

  ogen:gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ –≤—Å–µ—Ö OpenAPI-–¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π —Å x-ogen"
    deps: [ ogen:install, yq:install ]
    cmds:
      - task: redocly-cli:bundle
      - |
        find {{.OPEN_API_FILES}} -name '*.yaml' -o -name '*.yml' | while read -r file; do
          if [ -f "$file" ] && grep -q 'x-ogen:' "$file"; then
            echo "üöÄ Generating from: $file"
            target=$({{.YQ}} e '."x-ogen".target' "$file")
            package=$({{.YQ}} e '."x-ogen".package' "$file")
            echo "üìÅ Target: $target"
            echo "üì¶ Package: $package"
            {{.OGEN}} \
              --target "$target" \
              --package "$package" \
              --clean \
              "$file" || exit 1
          fi
        done

  gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö proto –∏ OpenAPI –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π"
    cmds:
      - task: proto:gen
      - task: ogen:gen

  deps:update:
    desc: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö"
    cmds:
      - |
        echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö"
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ $mod"
            (cd "$mod" && go mod tidy -compat=1.24) || exit 1
          fi
        done

  yq:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç yq –≤ bin/ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"
    cmds:
      - |
        [ -f {{.YQ}} ] || {
          echo 'üì¶ Installing yq...'
          GOBIN={{.BIN_DIR}} go install github.com/mikefarah/yq/v4@{{.YQ_VERSION}}
        }

  grpcurl:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç grpcurl –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.GRPCURL}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grpcurl {{.GRPCURL_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/fullstorydev/grpcurl/cmd/grpcurl@{{.GRPCURL_VERSION}}
        }
    status:
      - test -x {{.GRPCURL}}

  test-api:
    desc: "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤"
    deps: [ grpcurl:install ]
    cmds:
      - |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ gRPC –∏ REST"

        echo "üë§ –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ IAM (gRPC)"
        USER_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
        USER_LOGIN="test-${USER_UUID:0:8}"
        USER_EMAIL="$USER_LOGIN@example.com"
        REGISTER_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"login\":\"$USER_LOGIN\",\"password\":\"password123\",\"email\":\"$USER_EMAIL\"}" localhost:50053 user.v1.UserService/Register)

        if [[ "$REGISTER_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
          echo "üîç –û—Ç–≤–µ—Ç: $REGISTER_RESPONSE"
          exit 1
        fi

        echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: $USER_EMAIL"

        echo
        echo "üîê –¢–µ—Å—Ç 2: –õ–æ–≥–∏–Ω –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ session UUID (gRPC)"
        LOGIN_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"login\":\"$USER_LOGIN\",\"password\":\"password123\"}" localhost:50053 auth.v1.AuthService/Login)

        SESSION_UUID=$(echo $LOGIN_RESPONSE | grep -o '"sessionUuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$SESSION_UUID" ]; then
          SESSION_UUID=$(echo $LOGIN_RESPONSE | grep -o '"sessionUuid": "[^"]*' | cut -d'"' -f4)
        fi
        if [ -z "$SESSION_UUID" ]; then
          SESSION_UUID=$(echo $LOGIN_RESPONSE | grep -o '"session_uuid":"[^"]*' | cut -d'"' -f4)
        fi
        if [ -z "$SESSION_UUID" ]; then
          SESSION_UUID=$(echo $LOGIN_RESPONSE | grep -o '"session_uuid": "[^"]*' | cut -d'"' -f4)
        fi

        if [ -z "$SESSION_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å session UUID"
          echo "üîç –û—Ç–≤–µ—Ç: $LOGIN_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ —Å–µ—Å—Å–∏—è: $SESSION_UUID"

        echo
        echo "üì¶ –¢–µ—Å—Ç 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∏–∑ Inventory (—Å session UUID)"
        PARTS_RESPONSE=$({{.GRPCURL}} -plaintext -H "session-uuid: $SESSION_UUID" -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts)

        if [[ -z "$PARTS_RESPONSE" || "$PARTS_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi

        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
        PART_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -1 | cut -d'"' -f4)
        PART2_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -2 | tail -1 | cut -d'"' -f4)
        if [ -z "$PART_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ UUID –¥–µ—Ç–∞–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi
        if [ -z "$PART2_UUID" ]; then
          PART2_UUID=$PART_UUID
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π, –ø–µ—Ä–≤–∞—è UUID: $PART_UUID, –≤—Ç–æ—Ä–∞—è UUID: $PART2_UUID"

        echo
        echo "üîç –¢–µ—Å—Ç 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç–∞–ª–∏ –ø–æ UUID"
        PART_RESPONSE=$({{.GRPCURL}} -plaintext -H "session-uuid: $SESSION_UUID" -d "{\"uuid\":\"$PART_UUID\"}" localhost:50051 inventory.v1.InventoryService/GetPart)
        
        if [[ -z "$PART_RESPONSE" || "$PART_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ—Ç–∞–ª–∏."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –¥–µ—Ç–∞–ª–∏ 
        PART_NAME=$(echo $PART_RESPONSE | grep -o '"name": "[^"]*' | cut -d'"' -f4)
        if [ -z "$PART_NAME" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–º—è –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ –¥–µ—Ç–∞–ª—å: $PART_NAME"

        echo
        echo "üìù –¢–µ—Å—Ç 5: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (REST API)"
        ORDER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -H "X-Session-UUID: $SESSION_UUID" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")
        
        if [[ -z "$ORDER_RESPONSE" || "$ORDER_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_UUID" ]; then
          ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ —Å UUID: $ORDER_UUID"

        echo
        echo "üìä –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PENDING_PAYMENT)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID" \
          -H "X-Session-UUID: $SESSION_UUID")
        
        if [[ -z "$ORDER_INFO_RESPONSE" || "$ORDER_INFO_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_STATUS" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
            exit 1
          fi
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å PENDING_PAYMENT
        if [[ "$ORDER_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: $ORDER_STATUS"

        echo
        echo "üí∞ –¢–µ—Å—Ç 7: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (REST API)"
        PAY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER_UUID/pay" \
          -H "Content-Type: application/json" \
          -H "X-Session-UUID: $SESSION_UUID" \
          -d "{\"payment_method\":\"PAYMENT_METHOD_CARD\"}")
        
        if [[ "$PAY_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PAY_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω"

        echo
        echo "üìä –¢–µ—Å—Ç 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PAID)"
        echo "–ñ–¥—ë–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞..."
        sleep 3
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID" \
          -H "X-Session-UUID: $SESSION_UUID")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª PAID
        if [[ "$ORDER_STATUS" != *"PAID"* && "$ORDER_STATUS" != *"ASSEMBLED"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã. –û–∂–∏–¥–∞–ª—Å—è PAID –∏–ª–∏ ASSEMBLED, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: $ORDER_STATUS"

        echo
        echo "üìù –¢–µ—Å—Ç 9: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã (REST API)"
        ORDER2_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -H "X-Session-UUID: $SESSION_UUID" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART2_UUID\"]}")
        
        if [[ -z "$ORDER2_RESPONSE" || "$ORDER2_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_UUID" ]; then
          ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER2_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑ —Å UUID: $ORDER2_UUID"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID" \
          -H "X-Session-UUID: $SESSION_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞: $ORDER2_STATUS"

        echo
        echo "‚ùå –¢–µ—Å—Ç 10: –û—Ç–º–µ–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ (REST API)"
        echo "–û–∂–∏–¥–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π..."
        sleep 2
        
        curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER2_UUID/cancel" \
          -H "X-Session-UUID: $SESSION_UUID"
        
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã..."

        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID" \
          -H "X-Session-UUID: $SESSION_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"CANCELLED"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è CANCELLED, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          echo "üîç –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: $ORDER2_INFO"
          exit 1
        fi
        echo "‚úÖ –°—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã: $ORDER2_STATUS"
        
        echo
        echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã API —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"

  # ============================================================================
  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  # ============================================================================

  env:generate:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤"
    summary: |
      –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .env —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–æ–≤.
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç envsubst –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ deploy/env/.env.

      –°–µ—Ä–≤–∏—Å—ã: order, inventory, payment
    cmds:
      - |
        echo "üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env —Ñ–∞–π–ª—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ envsubst
        if ! command -v envsubst &> /dev/null; then
          echo "‚ö†Ô∏è  envsubst –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ npm..."
          if ! command -v npx &> /dev/null; then
            echo "‚ùå npm/npx –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ gettext (brew install gettext) –∏–ª–∏ npm"
            exit 1
          fi
          export ENV_SUBST="npx envsubst"
        else
          export ENV_SUBST="envsubst"
        fi

        export SERVICES="order,inventory,payment"
        bash deploy/env/generate-env.sh

  # ============================================================================
  # Database –∏ —Å–µ—Ä–≤–∏—Å—ã startup tasks
  # ============================================================================

  docker:network:create:
    desc: "–°–æ–∑–¥–∞—Ç—å Docker —Å–µ—Ç—å –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - echo "üåê –°–æ–∑–¥–∞–µ–º —Å–µ—Ç—å rocket-shop-network..."
      - docker network create rocket-shop-network 2>/dev/null || echo "‚úÖ –°–µ—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

  kafka:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Kafka"
    deps: [ docker:network:create ]
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Kafka..."
      - docker-compose -f deploy/compose/core/docker-compose.yml up -d
      - echo "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Kafka..."
      - sleep 5
      - echo "‚úÖ Kafka –≥–æ—Ç–æ–≤"

  kafka:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Kafka"
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Kafka..."
      - docker-compose -f deploy/compose/core/docker-compose.yml down
      - echo "‚úÖ Kafka –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  db:up:
    desc: "–ü–æ–¥–Ω—è—Ç—å –≤—Å–µ –ë–î –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (PostgreSQL + MongoDB + Redis –¥–ª—è IAM)"
    deps: [ docker:network:create, env:generate ]
    cmds:
      - echo "üöÄ –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–î..."
      - docker-compose -f deploy/compose/inventory/docker-compose.yml up -d
      - docker-compose -f deploy/compose/order/docker-compose.yml up -d
      - docker-compose -f iam/docker-compose.yml up -d
      - echo "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
      - sleep 5
      - echo "‚úÖ –ë–î –≥–æ—Ç–æ–≤—ã"

  db:seed:
    desc: "–ó–∞–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö inventory —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
    summary: |
      –ó–∞–ø–æ–ª–Ω—è–µ—Ç MongoDB –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö inventory —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
      –°–æ–∑–¥–∞–µ—Ç 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
    cmds:
      - echo "üå± –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."
      - cd inventory && go run cmd/seed/main.go
      - echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∞"

  db:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–î"
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ë–î..."
      - docker-compose -f deploy/compose/inventory/docker-compose.yml down -v
      - docker-compose -f deploy/compose/order/docker-compose.yml down -v
      - docker-compose -f iam/docker-compose.yml down -v
      - echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã"

  infra:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (Kafka + –ë–î + Observability)"
    cmds:
      - task: docker:network:create
      - task: env:generate
      - task: kafka:up
      - task: db:up
      - task: observability:up
      - echo '[OK] –í—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞'

  infra:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (Kafka + –ë–î + Observability)"
    cmds:
      - task: observability:down
      - task: db:down
      - task: kafka:down
      - echo '[OK] –í—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'

  services:start:payment:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Payment service (Go process –≤ —Ñ–æ–Ω–µ)"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Payment service..."
      - cd payment && go run cmd/main.go > /tmp/payment.log 2>&1 &
      - echo "‚úÖ Payment –∑–∞–ø—É—â–µ–Ω"

  services:start:assembly:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Assembly service (Go process –≤ —Ñ–æ–Ω–µ)"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Assembly service..."
      - cd assembly && go run cmd/main.go > /tmp/assembly.log 2>&1 &
      - echo "‚úÖ Assembly –∑–∞–ø—É—â–µ–Ω"

  services:start:notification:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Notification service (Go process –≤ —Ñ–æ–Ω–µ)"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Notification service..."
      - cd notification && go run cmd/main.go > /tmp/notification.log 2>&1 &
      - echo "‚úÖ Notification –∑–∞–ø—É—â–µ–Ω"

  services:start:iam:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å IAM service"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º IAM service..."
      - docker-compose -f iam/docker-compose.yml up -d --build
      - echo "‚úÖ IAM –∑–∞–ø—É—â–µ–Ω"

  services:start:inventory:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Inventory service"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Inventory service..."
      - docker-compose -f deploy/compose/inventory/docker-compose.yml up -d --build
      - echo "‚úÖ Inventory –∑–∞–ø—É—â–µ–Ω"

  services:start:order:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Order service"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Order service..."
      - docker-compose -f deploy/compose/order/docker-compose.yml up -d --build
      - echo "‚úÖ Order –∑–∞–ø—É—â–µ–Ω"

  services:start:envoy:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Envoy Gateway"
    cmds:
      - echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Envoy Gateway..."
      - docker-compose -f deploy/compose/envoy/docker-compose.yml up -d
      - echo "‚úÖ Envoy Gateway –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8080"

  services:start:all:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã"
    cmds:
      - task: services:start:iam
      - sleep 2
      - task: services:start:inventory
      - task: services:start:payment
      - sleep 2
      - task: services:start:order
      - sleep 3
      - task: services:start:assembly
      - sleep 3
      - task: services:start:notification
      - sleep 2
      - task: services:start:envoy
      - echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"

  services:stop:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ Go —Å–µ—Ä–≤–∏—Å—ã"
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Go —Å–µ—Ä–≤–∏—Å—ã..."
      - pkill -9 -f "go run" || true
      - sleep 1
      - echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

  start:all:
    desc: "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É (Kafka + –ë–î + –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã)"
    deps: [ infra:up ]
    cmds:
      - task: db:seed
      - sleep 2
      - task: services:start:all
      - |
        echo ""
        echo "üéâ –í—Å—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:"
        echo "   - Kafka: docker ps"
        echo "   - –°–µ—Ä–≤–∏—Å—ã: task services:logs:all"
        echo "   - API: curl http://localhost:8080/api/v1/orders"

  stop:all:
    desc: "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É (—Å–µ—Ä–≤–∏—Å—ã + –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)"
    cmds:
      - task: services:stop
      - task: infra:down
      - echo "‚úÖ –í—Å—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"

  services:logs:inventory:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Inventory service"
    cmds:
      - tail -50 /tmp/inventory.log

  services:logs:payment:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Payment service"
    cmds:
      - tail -50 /tmp/payment.log

  services:logs:order:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Order service"
    cmds:
      - tail -50 /tmp/order.log

  services:logs:assembly:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Assembly service"
    cmds:
      - tail -50 /tmp/assembly.log

  services:logs:notification:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Notification service"
    cmds:
      - tail -50 /tmp/notification.log

  services:logs:all:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - echo "=== Inventory ===" && tail -5 /tmp/inventory.log
      - echo "" && echo "=== Payment ===" && tail -5 /tmp/payment.log
      - echo "" && echo "=== Order ===" && tail -5 /tmp/order.log
      - echo "" && echo "=== Assembly ===" && tail -5 /tmp/assembly.log
      - echo "" && echo "=== Notification ===" && tail -5 /tmp/notification.log

  dev:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ: –ë–î + –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (development —Ä–µ–∂–∏–º)"
    cmds:
      - task: db:up
      - sleep 2
      - task: services:start:all
      - echo "üéâ Development –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!"
      - echo "üìã –õ–æ–≥–∏:"
      - task: services:logs:all

  dev:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ: –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã + –ë–î"
    cmds:
      - task: services:stop
      - task: db:down
      - echo "‚úÖ Development –æ–∫—Ä—É–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

  # =========================================
  # OBSERVABILITY TASKS (ELK Stack + OTLP)
  # =========================================

  observability:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Observability —Å—Ç–µ–∫ (Elasticsearch + Kibana + OTel Collector)"
    dir: deploy/compose/observability
    cmds:
      - docker compose up -d
      - sleep 5
      - echo "[OK] Observability —Å—Ç–µ–∫ –∑–∞–ø—É—â–µ–Ω"
      - echo ""
      - bash -c 'echo "Kibana UI at http://localhost:5601"'
      - bash -c 'echo "Elasticsearch at http://localhost:9200"'
      - bash -c 'echo "OTLP Collector (gRPC) at localhost:4317"'

  observability:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Observability —Å—Ç–µ–∫"
    dir: deploy/compose/observability
    cmds:
      - docker compose down -v
      - echo "[OK] Observability —Å—Ç–µ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  observability:logs:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Observability —Å—Ç–µ–∫–∞"
    dir: deploy/compose/observability
    cmds:
      - docker compose logs -f

  observability:restart:
    desc: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Observability —Å—Ç–µ–∫"
    cmds:
      - task: observability:down
      - sleep 2
      - task: observability:up

  logs:kibana:
    desc: "–û—Ç–∫—Ä—ã—Ç—å Kibana –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
    cmds:
      - bash -c 'open http://localhost:5601 2>/dev/null || xdg-open http://localhost:5601 2>/dev/null || echo "–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5601 –≤—Ä—É—á–Ω—É—é"'

  logs:elasticsearch:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å Elasticsearch"
    cmds:
      - bash -c 'curl -s http://localhost:9200/_cluster/health | jq .'
      - echo ""
      - bash -c 'echo "–ü–µ—Ä–µ–π—Ç–∏ –≤ Kibana at http://localhost:5601"'

  # =========================================
  # ENVOY GATEWAY TASKS
  # =========================================

  envoy:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å Envoy Gateway —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏"
    deps: [ docker:network:create ]
    dir: deploy/envoy
    cmds:
      - docker compose up -d --build
      - sleep 5
      - echo "‚úÖ Envoy Gateway –∑–∞–ø—É—â–µ–Ω"
      - echo "Gateway at http://localhost:8080"
      - echo "Admin at http://localhost:8081"

  envoy:down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Envoy Gateway"
    dir: deploy/envoy
    cmds:
      - docker compose down -v
      - echo "üõë Envoy Gateway –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  envoy:logs:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Envoy –∏ —Å–µ—Ä–≤–∏—Å–æ–≤"
    dir: deploy/envoy
    cmds:
      - docker compose logs -f

  envoy:restart:
    desc: "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Envoy Gateway"
    cmds:
      - task: envoy:down
      - sleep 2
      - task: envoy:up

  envoy:test:
    desc: "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Envoy Gateway (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, –∑–∞–ø—Ä–æ—Å—ã)"
    cmds:
      - |
        echo "=== 1. Health Check ==="
        curl -s http://localhost:8080/healthz | jq .
        
        echo -e "\n=== 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ==="
        REGISTER_RESP=$(curl -s -X POST http://localhost:8080/auth/register \
          -H "Content-Type: application/json" \
          -d '{"login":"testuser","password":"testpass","email":"test@example.com"}')
        echo $REGISTER_RESP | jq .
        
        echo -e "\n=== 3. –õ–æ–≥–∏–Ω ==="
        LOGIN_RESP=$(curl -s -X POST http://localhost:8080/auth/login \
          -H "Content-Type: application/json" \
          -d '{"login":"testuser","password":"testpass"}')
        echo $LOGIN_RESP | jq .
        
        SESSION_UUID=$(echo $LOGIN_RESP | jq -r '.session_uuid // .sessionUuid // empty')
        
        if [ -z "$SESSION_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å session_uuid"
          exit 1
        fi
        
        echo "‚úÖ Session UUID: $SESSION_UUID"
        
        echo -e "\n=== 4. Inventory –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 403) ==="
        curl -s http://localhost:8080/api/v1/inventory/parts | jq .
        
        echo -e "\n=== 5. Inventory —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π ==="
        curl -s -H "Cookie: X-Session-Uuid=$SESSION_UUID" \
          http://localhost:8080/api/v1/inventory/parts | jq .
        
        echo -e "\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
